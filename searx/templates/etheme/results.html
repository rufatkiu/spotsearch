{% extends "etheme/base.html" %}
{% from "etheme/macros.html" import search_link %}


{%- macro search_url() %}{{ base_url }}?q={{ q|urlencode }}{% if selected_categories %}&amp;categories={{ selected_categories|join(",") | replace(' ','+') }}{% endif %}{% if pageno > 1 %}&amp;pageno={{ pageno }}{% endif %}{% if time_range %}&amp;time_range={{ time_range }}{% endif %}{% if current_language != 'all' %}&amp;language={{ current_language }}{% endif %}{% endmacro -%}
{% block title %}{{ q|e }} - {% endblock %}
{% block meta %}<link rel="alternate" type="application/rss+xml" title="Spot search: {{ q|e }}" href="{{ search_url() }}&amp;format=rss">{% endblock %}
{% block content %}

    <div id="search_bar_area">
        {% include 'etheme/components/search_full.html' %}
    </div>

    {% set use_gallery_layout = 'images' in selected_categories or 'videos' in selected_categories %}
    <div class="container contents {% if use_gallery_layout or (not results and not answers) %} full {% endif %}">
        <div>
            {% if corrections %}
            <div class="result" id="corrections">
                <span class="text-muted">{{ _('Did you mean:') }}
                    {% for correction in corrections %}
                    {{ search_link(correction.title, correction.url, method) }}
                    {% endfor %}
                </span>
                ?
            </div>
            {% endif %}

            {% if answers and 'general' in selected_categories -%}
            {%- for answer in answers.values() %}
            <div class="result well">
              {% if answer.url %}
                <a href="{{ answer.url }}">{{ answer.answer }}</a>
              {% else %}
                <span>{{ answer.answer }}</span>
              {% endif %}
            </div>
            {%- endfor %}
            {%- endif %}

            {% if not results and not answers %}
                {% include 'etheme/messages/no_results.html' %}
            {% else %}


                {% macro put_results(results_slice, no_image=False) -%}
                {%- for result in results_slice %}
                {% set template = result.template|replace('.html', '') if result['template'] else None %}
                {% if no_image and template == "images" and not use_gallery_layout %}
                {% else %}
                <div class="result {% if template %}result-{{ template }}{% else %} result-default {% endif %}">
                    {% if template in ["torrent"] and not use_gallery_layout %}
                    <small class="result-template">{{template}}</small>
                    {% endif %}

                    {% set index = loop.index %}
                    {% if result.template %}
                        {# Torrents presented in a gallery like layout are different than the regular layout #}
                        {% if template == "torrent" and 'videos' in selected_categories %}
                        {% include get_result_template('etheme', 'video_torrent.html') %}
                        {% else %}
                        {% include get_result_template('etheme', result['template']) %}
                        {% endif %}
                    {% else %}
                        {% include 'etheme/result_templates/default.html' %}
                    {% endif %}
                </div>
                {% endif %}
                {%- endfor %}
                {%- endmacro %}


                <div id="results" {% if use_gallery_layout %} class="{{selected_categories[0]}}-gallery" {% endif %}>
                    {% if pageno == 1 and 'general' in selected_categories %}
                        <!-- Empty div for unit conversions -->
                        <div class="result" id="unit_conversions">
                            <script src="{{ url_for('static', filename='js/math.min.js') }}"></script>
                        </div>
                        {{ put_results(results[:3], True) }}
                      <div class='first-page-media-results'>
                        <div class='header'>
                          <b class="title">{{_("Images")}}</b>
                          {{ search_link(_("More"), q|e, method=method, time_range=time_range, lang=current_language, category="images") }}
                        </div>
                        <div id='default_images_container'></div>
                      </div>
                      <div class='first-page-media-results'>
                        <div class='header'>
                          <b class="title">{{_("Videos")}}</b>
                          {{ search_link(_("More"), q|e, method=method, time_range=time_range, lang=current_language, category="videos") }}
                        </div>
                        <div class='videos-gallery'></div>
                      </div>
                    {% endif %}
                    {{ put_results(results[4:], True) }}
                </div>

                {% if paging %}
                {% macro search_form_attrs(pageno) -%}
                    {%- for category in selected_categories -%}
                        <input type="hidden" name="category_{{ category }}" value="1"/>
                    {%- endfor -%}
                    <input type="hidden" name="q" value="{{ q|e }}" />
                    <input type="hidden" name="pageno" value="{{ pageno }}" />
                    <input type="hidden" name="time_range" value="{{ time_range }}" />
                    <input type="hidden" name="language" value="{{ current_language }}" />
                {%- endmacro %}

                <div id="pagination" {% if rtl %} class="rtl" {% endif %} >
                    <form method="{{ method or 'POST' }}" action="{{ url_for('search') }}">
                        {{ search_form_attrs(pageno - 1) }}
                        <button type="submit" class="btn btn-default" {% if pageno == 1 %}disabled{% endif %}><span class="glyphicon glyphicon-forward"></span> {{ _('previous page') }}</button>
                    </form>
                    <form method="{{ method or 'POST' }}" action="{{ url_for('search') }}">
                        {{ search_form_attrs(pageno + 1) }}
                        <button type="submit" class="btn primary"><span class="glyphicon glyphicon-backward"></span> {{ _('next page') }}</button>
                    </form>
                </div><!-- /#pagination -->
                {% endif %}

            {% endif %}

        </div>

        <div>
            {% if errors %}
            {% from 'etheme/macros.html' import errors_panel %}
            {{ errors_panel(errors) }}
            {% endif %}

            {% if infoboxes %}
                {% for infobox in infoboxes %}
                    {% include 'etheme/components/infobox.html' %}
                {% endfor %}
            {% endif %}


            {% if suggestions %}
            <div id="suggestions" class="infobox">
                <h4 class="panel-title">{{ _('Suggestions') }}</h4>
                <p>
                    {% for suggestion in suggestions %}
                    {{ search_link(suggestion.title, suggestion.url, method) }}
                    {% endfor %}
                </p>
            </div>
            {% endif %}
        </div>


    </div>

    <script>
        let q = {{ q | tojson }}

        // Define custom units here
        math.createUnit('mph', '1 mile/hour')
        math.createUnit('kmph', '1 km/hour')
        math.createUnit('sqmt', '1 m2')
        math.createUnit('cumt', '1 m3')

        const exp = new RegExp(".*?(\\d+(?:\\.\\d+)?)\s?([^.0-9]+) (?:in|to|en|dans|nel|pour|para|zu) ([^.0-9]+)", "i");
        let m = q.match(exp)
        let answer_section = null
        if (m) {
            try {
                let value = math.evaluate(m[1] + m[2] + " to " + m[3])

                if (value.toString() !== q) {
                    
                    let info = math.evaluate(1 + m[2] + " to " + m[3])
                    // Round off solution to 5 decimals
                    let sol = math.round(Number(value.toString().split(" ")[0]), 5)
                    answer_section = `
                    <div class="result conversion-value">
                        <span>
                            ${sol} ${m[3]}
                        </span>
                    </div>
                    <div class="result conversion-info">
                        <span class="conversion">
                            1 ${m[2]} = ${info}
                        </span>
                    </div>
                    `
                }
            } catch (error) {
                // pass exception here
                // nothing to do
            }
            
        } else {
            try {
                let value = math.evaluate(q)
                if (value.toString() !== q) {
                    
                    if (typeof(value) === "number" || typeof(value) === "object") {
                        answer_section = `
                        <div class="result conversion-value">
                            <span>
                                ${q} = ${value}
                            </span>
                        </div>
                        `
                    }
                }
            } catch (error) {
                // pass exception here
                // nothing to do
            }
            
        }

        document.getElementById('unit_conversions').innerHTML = answer_section
        
        // Do not show currency when conversions is active
        if (answer_section) {
            let currency = document.getElementById('currency')
            if (currency) {
                currency.remove()
            }
        }

    </script>

{% endblock %}
